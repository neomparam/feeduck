<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <link rel="stylesheet" type="text/css" href="bootstrap-3.0.1-dist/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="non-responsive.css" media="screen" />

    <link rel="stylesheet" href="http://neomparam.github.io/feeduck/feeduck.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="assets/feeduck-host.css" media="screen" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Feeduck</title>
    <script type="text/javascript">
      var progress;

      function createForm() {
        if (document.getElementById("title").value == "") {
          $("#title").parents().addClass("has-error");
          return false;
        }

        $("#title").parents().removeClass("has-error");

        $("#response").hide();
        $("#form_create input[type=text]").blur();
        $("#form_create input[type=text]").prop("disabled", true);
        $("#form_create button[type=submit]").prop("disabled", true);

        // load GAS script
        var url = "https://script.google.com/macros/s/AKfycbzcw8Gr8Z5lLA1b9CZtYm-1__Ymr8AHxygGtlyZL2NR3nhtO5Q/exec";
        var script = document.createElement("script");
        script.setAttribute('type', 'text/javascript');
        script.setAttribute('src', url + "?a=create&c=onJsonpResponse&title=" + document.getElementById("title").value);
        document.getElementsByTagName('head')[0].appendChild(script);

        // gs.create($("#title").val(), onJsonpResponse);

        // show progress bar
        progress.val(0);
        progress.show();
        progress.start(10);

        return false;
      }

//      function onJsonpResponse(form_id, entry_id, spreadsheetUrl) {
      function onJsonpResponse(data) {
        $("#progress").hide();
        $("#form_create input[type=text]").prop("disabled", false);
        $("#form_create button[type=submit]").prop("disabled", false);
        // show response
        $("#response").show();

        var form_id = data.formId;
        var entry_id = data.entryId;
        var spreadsheetUrl = data.spreadsheetUrl;

        $("#response .target-spreadsheet-link").attr('href', spreadsheetUrl);

        var code = $("#response .code");
        code.text('' +
          '<script src="http://code.jquery.com/jquery-1.10.2.min.js"></scr' + 'ipt>\n' +
          '<script type="text/javascript" src="http://neomparam.github.io/feeduck/feeduck.jquery.js"></scr' + 'ipt>\n' + 
          '<link rel="stylesheet" href="http://neomparam.github.io/feeduck/feeduck.css" type="text/css" />\n' + 
          '<script>\n' + 
          '\tFeeduck.init({\n' +
          '\t\tform_id: "'+form_id+'",\n' +
          '\t\tentry_id: "'+entry_id+'",\n' +
          '\t\tplaceholder: "의견을 남겨주세요.",\n' +
          '\t\tthanks_message: "<p>소중한 의견 감사합니다.</p>",\n' +
          '\t\tsend_callback: function(text) {\n' +
          '\t\t},\n' +
          '\t});\n' +
          '</scr' + 'ipt>'
        );

        addFile2(data);

        // prop = {
        //   version: '0.1',
        //   file_id: form_id,
        //   data: {
        //     entry_id: entry_id
        //   }
        // };
        // insertProperty(form_id, 'feeduck', JSON.stringify(prop), 'PUBLIC');
        // loadFiles();
      }

      function checkAuth() {
        showPage("waiting-page");
        gs.checkAuth(
          function () {
            showPage("page_main");
//            gs.getList(showList);
          },
          function () {
            showPage("page_login");
            $("#btnLogin").click(function(e) {
              document.location.href = config.url + '?r=' + document.location.href;
              e.preventDefault();
              return false;
            });
          }
        );
      }

      function addFile(file) {
        var ul = $("#files");

        var li = $("<li></li>");
        var a = $("<a></a>");
        a.attr("href", file.spreadsheetUrl).attr("target", "_blank").text(file.title).appendTo(li);
        li.addClass("list-group-item").appendTo(ul);
      }

      function addFile2(file) {
        var ul = $("#files");

        var li = $("<li></li>");
        var a = $("<a></a>");
        a.attr("href", file.spreadsheetUrl).attr("target", "_blank").text(file.title).appendTo(li);
        li.addClass("list-group-item").prependTo(ul);
      }

      function showList(files) {
        var ul = $("#files");
        ul.html("");

        for ( var i = 0 ; i < files.length; i++ )
        {
          var f = files[i];
          if ( f == undefined )
            continue;

          addFile(f);
        }
      }

      // main
      $(function() {
        checkAuth();
        progress = new Progress(document.getElementById("progress"));
      })
    </script>
    <!--script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script-->
  </head>
  <body>
    <div class="container">
      <header>
        <div class="page-header">
          <h1>Feeduck <small>간편하게 피드백을 받으세요!</small><span class="pull-right"><a href="https://drive.google.com" target="_blank"><span style="font-size: 40%;">Google Drive</span></a></span></h1>
        </div>
        <div class="hidden">
          <button id="test" class="btn btn-danger" onclick="test();">TEST</button>
        </div>
      </header>
      <div id="content">
        <div>
          <p>
              사용자 건의사항을 바로 받아볼 수 있습니다. <br>
              따로 저장소를 구성할 필요 없이, 구글 스프레드시트에 바로 저장하세요.
          </p>
        </div>
        <hr />
        <div id="waiting-page" class="page">
          <p>
              구글 로그인 확인 중<span class="dots">.</span>
              <script>
                setInterval(function() {
                    var prevLength = $("#waiting-page .dots").text().length;
                    var nextLength = (prevLength + 1) % 4;
                    var dots = "";
                    for(var i = 0; i < nextLength; i++) {
                        dots += ".";
                    }
                    $("#waiting-page .dots").text(dots);
                }, 1000);
              </script>
          </p>
        </div>

        <div id="page_login" class="page">
          <p>
              구글 스프레드시트를 생성하기 위해 로그인이 필요합니다.
          </p>
          <button type="button" id="btnLogin" class="btn btn-primary btn-lg">Login with Google.</button>
        </div>

        <div id="page_main" class="page">
          <div class="jumbotron">

            <form class="" role="form" id="form_create" name="" action="#" onsubmit="return createForm();">
              <div class="form-group">
                <h3>스프레드시트 생성</h3>
                <input type="text" class="form-control input-lg" name="title" id="title" placeholder="저장할 스프레드시트 이름을 입력하세요."/>
              </div>
              <button type="submit" class="btn btn-primary input-lg" style="width:120px;font-size:18px;">Create</button>
              <div id="progress" style="margin-top:20px;display:none;">
                <p>구글에 접속하여 스프레드시트를 생성 중입니다.</p>
                <div id="progress_create" class="progress progress-striped active">
                  <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div>
                </div>
              </div>
            </form>

            <div id="response" style="display:none;margin-top:20px;">
              <h3>스프레드시트를 생성이 완료되었습니다.</h3>

              <p>아래 코드를 웹사이트에 붙여넣으면 피드백을 받을 수 있습니다.</p>
              <textarea id="code" class="code form-control" rows="13"></textarea>

              <p>
                설문 결과는 <a class="target-spreadsheet-link" href="" target="_blank">
                    <img src="assets/google-spreadsheet.favicon.png" style="position:relative; bottom: 3px;"/> 여기
                </a>에서 확인하세요
              </p>
            </div>
          </div>

          <!-- 생성된 form or spreadsheet 보여주기 -->
          <!--
          <h2>
            Spreadsheets
            <span class="pull-right"><a href="https://drive.google.com" target="_blank"><span style="font-size: 50%;">Google Drive</span></a></span>
          </h2>
          <ul id="files" class="list-group">
          </ul>
          -->
          <!-- 생성된 form or spreadsheet 보여주기 -->
        </div>
      </div>

      <footer style="border-top: 1px solid #EEEEEE;margin: 20px 0 40px;padding-top: 9px;">
        Feeduck is maintained by <a href="https://github.com/jangxyz">Kim, Jang-hwan</a> and <a href="https://github.com/neomparam">neomparam</a>.
      </footer>
    </div>
    <script type="text/javascript" src="assets/feeduck-host.js"></script>
    <script type="text/javascript" src="bootstrap-3.0.1-dist/dist/js/bootstrap.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-45361074-1', 'neomparam.github.io');
      ga('send', 'pageview');
    </script>
    <script type="text/javascript" src="http://neomparam.github.io/feeduck/feeduck.jquery.js"></script>
    <script>
      Feeduck.init({
        form_id: "1U7o3Ll74n4p9rCc8vADJWtdPtohhn9lYTasxx9203Uc",
        entry_id: "323808949",
        placeholder: "의견을 남겨주세요.",
        thanks_message: "<p>소중한 의견 감사합니다.</p>",
        send_callback: function(text) {
        },
      });
    </script>    
  </body>
</html>
