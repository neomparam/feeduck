<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <link rel="stylesheet" type="text/css" href="bootstrap-3.0.1-dist/dist/css/bootstrap.min.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="non-responsive.css" media="screen" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Feeduck</title>
  	<script type="text/javascript">
  		function create_form() {
  			var url = "https://script.google.com/macros/s/AKfycbzcw8Gr8Z5lLA1b9CZtYm-1__Ymr8AHxygGtlyZL2NR3nhtO5Q/exec";
  			var script = document.createElement("script");
  			script.setAttribute('type', 'text/javascript');
  			script.setAttribute('src', url + "?title=" + document.getElementById("title").value);
  			
  			document.getElementsByTagName('head')[0].appendChild(script);
  			
  			return false;
  		}
  		
  		function onJsonpResponse(form_id, entry_id) {
        var code = $("#code");
        code.text("<script type=\"text/javascript\" src=\"http://neomparam.github.io/feeduck/feeduck.js\"></scr" + "ipt><script>Feeduck.init({form_id:\""+form_id+"\",entry_id:\""+entry_id+"\"})</scr" + "ipt>");
  		}

      function handleClientLoad() {
        gapi.client.load('drive', 'v2');
        window.setTimeout(checkAuth, 1);
      }

      var config = {
        'client_id': '643481099244.apps.googleusercontent.com',
        'scope': 'https://www.googleapis.com/auth/drive',
        'immediate': true
      };

      function checkAuth() {
        config.immediate = true;
        gapi.auth.authorize(config, resultAuth);
      }

      function resultAuth(authResult) {
        if ( authResult && !authResult.error )
        {
          $("#panLogin").hide();
          $("#panMain").show();
          loadFiles(function(files) {
            var ul = $("#files");
            ul.html("");

            for ( var i = 0 ; i < files.length; i++ )
            {
              var f = files[i];
              if ( f == undefined )
                continue;

              var li = $("<li></li>");
              // li.text(f.title + " - " + f.id);
              li.text(f.title);
              li.appendTo(ul);
            }
          });
        }
        else
        {
          $("#panLogin").show();
          $("#panMain").hide();
          $("#btnLogin").click(function() {
            config.immediate = false
            gapi.auth.authorize(config, resultAuth);
          });
        }
      }

      function loadFiles(callback) {
        var retrievePageOfFiles = function(request, result) {
          request.execute(function(resp) {
            if ( !resp )
            {
              callback(result);
              return;
            }
            result = result.concat(resp.items);
            var nextPageToken = resp.nextPageToken;
            if (nextPageToken) {
              request = gapi.client.drive.files.list({
                'pageToken': nextPageToken
              });
              retrievePageOfFiles(request, result);
            } else {
              callback(result);
            }
          });
        }        
        
        var initialRequest = gapi.client.drive.files.list({'q': 'mimeType = "application/vnd.google-apps.form" and trashed = false and "root" in parents', 'fields':'items(fileExtension,id,mimeType,title)'});
//        var initialRequest = gapi.client.drive.files.list({'maxResults': 100, 'q': 'mimeType = "application/vnd.google-apps.folder" and trashed = false and "root" in parents'});
        retrievePageOfFiles(initialRequest, []);
      }

function retrieveAllChanges(callback, startChangeId) {
  var retrievePageOfChanges = function(request, result) {
    request.execute(function(resp) {
      result = result.concat(resp.items);
      var nextPageToken = resp.nextPageToken;
      // if (nextPageToken) {
      //   request = gapi.client.drive.changes.list({
      //     'pageToken': nextPageToken
      //   });
      //   retrievePageOfChanges(request, result);
      // } else {
        callback(result);
      // }
    });
  }
  var initialRequest;
  if (startChangeId) {
    initialRequest = gapi.client.drive.changes.list({
      'startChangeId' : startChangeId
    });
  } else {
    initialRequest = gapi.client.drive.changes.list();
  }
  retrievePageOfChanges(initialRequest, []);
}

function watchChange(channelId, channelType, channelAddress) {
  var resource = {
    'id': channelId,
    'type': channelType,
    'address': channelAddress
  };

  var request = gapi.client.drive.changes.watch({
    'resource': resource
  });
console.log(request);
  request.execute(function(channel){console.log(channel);});
}

      $(function() {
        $("#btnWatch").click(function() {
          watchChange("4ba78bf0-6a47-11e2-bcfd-0800200c9a77", "asdfdas", "192.168.0.1");
          // retrieveAllChanges(function(result) {
          //   console.log(result);
          // });
        });
      })
  	</script>
    <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Feeduck</h1>
      </header>
      <div id="panLogin">
        <!--button type="button" id="btnLogin" class="btn">Login with Google.</button-->
      </div>
      <div id="panMain" style="display:none">
        <div class="jumbotron">
          <form class="form-inline" role="form" id="" name="" action="https://script.google.com/macros/s/AKfycbzcw8Gr8Z5lLA1b9CZtYm-1__Ymr8AHxygGtlyZL2NR3nhtO5Q/exec" onsubmit="return create_form();">
            <div class="form-group">
              <label class="sr-only" for="title">Title</label>
              <input type="text" class="form-control" name="title" id="title" placeholder="제목을 입력하세요."/>
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
          </form>
          <div id="response">
            <label>아래의 코드를 복붙하세요.</label>
            <textarea id="code" class="form-control" rows="5"></textarea>
          </div>
        </div>
        <div>
          <button id="btnWatch">Watch</button>
          <h2>Files</h2>
          <ul id="files">
          </ul>
        </div>
      </div>
      <footer>
        Feeduck is maintained by <a href="https://github.com/jangxyz">Kim, Jang-hwan</a> and <a href="https://github.com/neomparam">neomparam</a><br>
        This page was generated by <a href="http://pages.github.com">GitHub Pages</a>.
      </footer>
    </div>
  </body>
</html>
